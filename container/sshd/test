#!/usr/bin/env bash
set -euox pipefail
cd "$(dirname "$0")"

docker rm -f test-sshd || true
docker run -d -p 22 --name test-sshd sshd
PORT="$(docker port test-sshd | sed 's/22\/tcp -> 0.0.0.0://')"

# TODO create a key pair on the fly
docker exec test-sshd /usr/local/sbin/add-uid-key fooba "$(cat ~/.ssh/my_public_key)"

# intentionally testing twice, just to make sure that ssdh isn't in debugging mode and quit after first use
ssh -o "StrictHostKeyChecking=no" -p $PORT fooba@localhost echo "1. hello, world."
ssh -o "StrictHostKeyChecking=no" -p $PORT fooba@localhost echo "2. hello, world."

docker rm -f test-sshd

echo Test successful.

